var express=require("express"),app=express();require("./config/middleware.js")(app,express),module.exports=app;var db=require("./data/db_schema.js"),bodyParser=require("body-parser"),fs=require("fs");module.exports=function(e,r){var o=r.Router(),s=r.Router();e.use(bodyParser.json()),e.use(bodyParser.urlencoded({extended:!1})),e.use(r["static"](__dirname+"/../../client")),e.use("/api/search",o),e.use("/api/users",s),require("../search/search_router.js")(o),require("../users/users_router.js")(s),e.get("/*",function(e,r){fs.createReadStream(__dirname+"/../../client/index.html").pipe(r)})};var mongoose=require("mongoose"),options={server:{socketOptions:{connectTimeoutMS:1e6,maxTimeMS:1e5}}},databaseUrl="mongodb://localhost/server/data/db/";mongoose.connect("mongodb://localhost/server/data/db/");var db=mongoose.connection;db.on("error",console.error.bind(console,"My own Connection Error")),db.once("open",function(){console.log("Connection to localhost:8000/server/data/db is open")}),module.exports=db;var api_router=require("./../data/api_requests/api_router.js");module.exports=searchControls={handleSearch:function(e,r){console.log("search req body",e.body),searchControls.makeRequest(e.body,r)},makeRequest:function(e,r){var o={location:e.location,searchTerm:e.opt1};api_router.askYelp(o,r)}};var searchController=require("./search_controller.js");module.exports=function(e){e.route("/").post(searchController.handleSearch)};var _=require("../../client/lib/bower_components/underscore/underscore.js"),users=[[["a","b","c"],["a","d","e"]],[[["a","b","y"]],["p","y","x"]],[["a","r","b"],["a","t","v"]]],numOfPeople=users.length;module.exports=function(){function e(e){var r=[];return console.log(e),e.forEach(function(e){-1!==r.indexOf(e)&&r.push(e)}),r}function r(e){var r={};return e.forEach(function(e){r[e]?r[e]++:r[e]=1}),console.log(r),r}function o(e,r){for(var o=[];o.length<3;){var s=_.reduce(Object.keys(e),function(r,o){return e[r]>e[o]?r:o}),n=[s,e[s]];delete e[s],o.push(n)}return o}function s(e,r){return(100*e/r).toFixed(2)}function n(s){var n=s.map(function(r){return e(r[0].concat(r[1]))});return o(r(_.flatten(n)))}return n(users),{totalUserPrefs:e,histogram:r,threeHeighest:o,percentage:s,parseBestOptions:n}}();var Users=require("./users_model.js"),jwt=require("jwt-simple"),Q=require("q");module.exports=userControls={signup:function(e,r){console.log("in users_controller.js: attempting to signup user");var o={username:e.body.username,email:e.body.email,password:e.body.password},s=Q.nbind(Users.findOne,Users);s({email:o.email}).then(function(e){return e?void console.log("ERROR: in users_controller signup"):Users.create(o)}).then(function(e){var o=jwt.encode(e,"secret");r.json({token:o})}).fail(function(e){console.error(e)})},signin:function(e,r){console.log("in users_controller.js: attempting to signin user");var o={email:e.body.email,password:e.body.password};console.log("currUser attempting login",o);var s=Q.nbind(Users.findOne,Users);s({email:o.email}).then(function(e){if(e){if(console.log("db resp of user",e),e.password===o.password){var s=jwt.encode(e,"secret");r.json({token:s})}}else console.log("not a user!")}).fail(function(e){console.error(e)})},checkAuth:function(e,r){console.log("in users_controller.js: attempting to checkAuth")},editUserProfile:function(e,r){console.log("in users_controller.js: attempting to edit profile")}};var mongoose=require("mongoose"),bcrypt=require("bcrypt"),UserSchema=new mongoose.Schema({username:{type:String,required:!0,unique:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0,unique:!0},salt:String,profile:[{firstName:{type:String},lastName:{type:String},preferences:{type:[String]},vegetarian:{type:String},vegan:{type:String},gultenFree:{type:String}}],friends:{type:[String]}});module.exports=mongoose.model("users",UserSchema);var usersController=require("./users_controller.js");module.exports=function(e){e.post("/signup",usersController.signup),e.post("/signin",usersController.signin),e.get("/auth",usersController.checkAuth),e.route("/profile").post(usersController.editUserProfile)};var Yelp=require("./restaurant_search.js");module.exports={askYelp:function(e,r){Yelp.askYelp(e,r)}};var Yelp=require("yelp"),yelp=new Yelp({consumer_key:"ju7T0GatX3G3terGQa8qAg",consumer_secret:"xxqTDZc8wGUxCcvzxgaVaRKeGY8",token:"gTsZIinUjEwsPzCcaA_CXLzjN4WSiZOO",token_secret:"D4W6WFkDcsxrADvwLMcv3ZrDJdA"});module.exports.askYelp=function(e,r){console.log("search criteria",e);var o="restaurants",s=e.searchTerm,n=e.location;yelp.search({category_filter:o,term:s,location:n}).then(function(e){r.status(200).json(e.businesses)})["catch"](function(e){console.log("error inside restaurant_search.js askYelp",e)})};